{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center fade-in">
    <div class="col-lg-8">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
                <li class="breadcrumb-item active">提交作业</li>
            </ol>
        </nav>
        
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-clipboard-check me-3" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <div>
                        <h2 class="mb-1">{{ assignment.title }}</h2>
                        <p class="text-muted mb-0">
                            <i class="bi bi-calendar-event me-1"></i>
                            截止日期：{{ assignment.deadline.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                    </div>
                </div>
                
                <div class="assignment-description p-3 mb-4 rounded" style="background-color: rgba(0, 0, 0, 0.02);">
                    <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>作业要求</h5>
                    <p class="mb-0">{{ assignment.description }}</p>
                </div>
                
                {% if assignment.deadline < now %}
                <div class="alert alert-danger mb-4">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    注意：当前作业已经超过截止日期，您仍然可以提交，但可能会被标记为迟交。
                </div>
                {% elif (assignment.deadline - now).days < 1 %}
                <div class="alert alert-warning mb-4">
                    <i class="bi bi-alarm-fill me-2"></i>
                    注意：距离截止日期不足24小时，请尽快完成提交。
                </div>
                {% endif %}
                
                <!-- 文件命名提醒 -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex">
                        <i class="bi bi-file-earmark-text me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="mb-2">重要提示：文件命名规范</h5>
                            <p class="mb-1">请按照以下格式命名您的文件：<strong class="text-danger">姓名_学号</strong>，例如：<code>张三_2023001234.py</code></p>
                            <p class="mb-0">正确命名有助于教师快速识别和批改您的作业，不规范的命名可能影响成绩评定。</p>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <form method="POST" enctype="multipart/form-data" id="submitForm">
                    <div class="mb-4">
                        <label for="content" class="form-label fw-bold">
                            <i class="bi bi-pencil-square me-2"></i>作业内容
                        </label>
                        <textarea class="form-control" id="content" name="content" rows="8" placeholder="请在此处输入您的作业内容，也可以上传文件作为补充..."></textarea>
                        <small class="text-muted">您可以在这里直接输入文字内容，并/或上传相关文件</small>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <label for="files" class="form-label fw-bold mb-3">
                                <i class="bi bi-file-earmark-arrow-up me-2"></i>上传文件
                            </label>
                            
                            <div class="file-upload-container p-4 mb-3 text-center border rounded" style="border-style: dashed !important;">
                                <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: var(--primary-color);"></i>
                                <p class="mt-3 mb-2">点击选择文件或拖放文件到此处</p>
                                <small class="text-muted d-block mb-3">支持多个文件上传</small>
                                <input type="file" class="form-control" id="files" name="files" multiple style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                            
                            <div class="selected-files"></div>
                            
                            <div class="d-flex mb-2">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                <div class="small">
                                    <strong>支持的文件类型：</strong> txt, pdf, png, jpg, jpeg, gif, doc, docx, py, zip, rar<br>
                                    <strong>单个文件大小限制：</strong> 16MB
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-arrow-left me-2"></i>返回首页
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-send me-2"></i>提交作业
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-lightbulb me-2 text-warning"></i>提交须知
                </h5>
                <ul class="mb-0">
                    <li>提交后仍可在截止日期前重新提交</li>
                    <li>教师将只看到您的最新提交内容</li>
                    <li>确保您的文件格式符合作业要求</li>
                    <li><strong>请务必按照 "姓名_学号" 的格式命名文件</strong></li>
                    <li>如遇技术问题，请及时联系教师</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('input[type="file"]');
    const fileListContainer = document.querySelector('.selected-files');
    
    fileInput.addEventListener('change', function() {
      fileListContainer.innerHTML = '';
      
      if (this.files.length > 0) {
        const fileList = document.createElement('div');
        fileList.className = 'list-group mt-3';
        
        // 添加命名提示标志
        let hasWarning = false;
        
        Array.from(this.files).forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
          
          // 检查文件名是否符合命名规范(姓名_学号格式)
          const fileName = file.name;
          const namePattern = /^[\u4e00-\u9fa5a-zA-Z]+_\d+\.\w+$/;
          const isValidName = namePattern.test(fileName);
          
          // 确定文件图标
          let fileIcon = 'bi-file-earmark';
          if (file.type.includes('image')) fileIcon = 'bi-file-earmark-image';
          else if (file.type.includes('pdf')) fileIcon = 'bi-file-earmark-pdf';
          else if (file.type.includes('zip') || file.type.includes('rar')) fileIcon = 'bi-file-earmark-zip';
          else if (file.type.includes('word')) fileIcon = 'bi-file-earmark-word';
          else if (file.type.includes('text')) fileIcon = 'bi-file-earmark-text';
          
          // 添加文件名警告指示器
          let nameWarning = '';
          if (!isValidName) {
            hasWarning = true;
            nameWarning = '<span class="ms-2 text-danger"><i class="bi bi-exclamation-circle"></i> 文件名不符合规范</span>';
          }
          
          fileItem.innerHTML = `
            <div>
              <i class="bi ${fileIcon} me-2"></i>
              <span>${file.name}</span>
              ${nameWarning}
            </div>
            <span class="badge bg-primary rounded-pill">${(file.size / 1024).toFixed(1)} KB</span>
          `;
          
          fileList.appendChild(fileItem);
        });
        
        fileListContainer.appendChild(fileList);
        
        // 如果有文件名不规范，添加警告提示
        if (hasWarning) {
          const warningDiv = document.createElement('div');
          warningDiv.className = 'alert alert-warning mt-3';
          warningDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>注意：</strong> 您上传的部分文件名不符合"姓名_学号"的命名规范，为了确保作业能被正确识别，建议重命名后再上传。
          `;
          fileListContainer.appendChild(warningDiv);
        }
      }
    });
    
    // 表单提交前检查文件名是否规范
    document.getElementById('submitForm').addEventListener('submit', function(e) {
      const files = fileInput.files;
      if (files.length > 0) {
        let hasInvalidName = false;
        const namePattern = /^[\u4e00-\u9fa5a-zA-Z]+_\d+\.\w+$/;
        
        Array.from(files).forEach(file => {
          if (!namePattern.test(file.name)) {
            hasInvalidName = true;
          }
        });
        
        if (hasInvalidName) {
          if (!confirm('您上传的部分文件名不符合"姓名_学号"的命名规范，这可能导致教师无法正确识别您的作业。是否仍要继续提交？')) {
            e.preventDefault();
          }
        }
      }
    });
  });
</script>
{% endblock %} 